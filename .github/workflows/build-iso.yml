name: "Build Installer ISO"

on:
  push:
    branches: [ master ]
    paths: 
      - 'hosts/installer/**'
      - 'scripts/install-axios.sh'
      - '.github/workflows/build-iso.yml'
  release:
    types: [published]
  workflow_dispatch:

concurrency:
  group: build-iso-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-iso:
    name: "Build axiOS Installer ISO"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: wimpysworld/nothing-but-nix@main

      - uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: true
          
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build ISO
        run: |
          nix build .#iso -L --show-trace

      - name: Get ISO filename
        id: iso
        run: |
          ISO_PATH=$(find result/iso -name "*.iso" -type f | head -n1)
          ISO_NAME=$(basename "$ISO_PATH")
          echo "path=$ISO_PATH" >> $GITHUB_OUTPUT
          echo "name=$ISO_NAME" >> $GITHUB_OUTPUT

      - name: Copy ISO to writable location
        run: |
          mkdir -p iso-output
          cp result/iso/*.iso iso-output/
          
      - name: Generate checksums
        run: |
          cd iso-output
          sha256sum *.iso > SHA256SUMS
          cat SHA256SUMS

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: axios-installer-iso
          path: |
            iso-output/*.iso
            iso-output/SHA256SUMS
          retention-days: 30

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            iso-output/*.iso
            iso-output/SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
