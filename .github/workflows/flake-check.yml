name: Flake Check

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

jobs:
  flake-check:
    name: Validate flake
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - uses: cachix/cachix-action@v16
        with:
          name: axios
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Check flake structure
        run: |
          echo "üîç Checking flake structure..."
          nix flake check --all-systems --no-update-lock-file

      - name: Show flake metadata
        run: nix flake metadata

  build-examples:
    name: Build example configurations
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example:
          - example-config
    steps:
      - uses: actions/checkout@v6

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - uses: cachix/cachix-action@v16
        with:
          name: axios
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Check example flake
        run: |
          echo "üîç Checking example: ${{ matrix.example }}"
          cd examples/${{ matrix.example }}
          nix flake check --no-build

      - name: Validate example builds (dry-run)
        run: |
          echo "üèóÔ∏è Validating build for: ${{ matrix.example }}"
          cd examples/${{ matrix.example }}
          CONFIG=$(nix eval .#nixosConfigurations --apply builtins.attrNames --json | jq -r '.[0]')
          echo "Building configuration: $CONFIG"
          nix build .#nixosConfigurations.$CONFIG.config.system.build.toplevel --dry-run
