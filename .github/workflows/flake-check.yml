name: Flake Check

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

jobs:
  flake-check:
    name: Validate flake
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - uses: cachix/cachix-action@v16
        with:
          name: axios
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Check flake structure
        run: |
          echo "ðŸ” Checking flake structure..."
          nix flake check --all-systems --no-update-lock-file

      - name: Show flake metadata
        run: nix flake metadata

  build-examples:
    name: Build example configurations
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example:
          - minimal-flake
          - multi-host
    steps:
      - uses: actions/checkout@v5

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - uses: cachix/cachix-action@v16
        with:
          name: axios
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Check example flake
        run: |
          echo "ðŸ” Checking example: ${{ matrix.example }}"
          cd examples/${{ matrix.example }}
          nix flake check --no-build

      - name: Validate example builds (dry-run)
        run: |
          echo "ðŸ—ï¸ Validating build for: ${{ matrix.example }}"
          cd examples/${{ matrix.example }}
          CONFIG=$(nix eval .#nixosConfigurations --apply builtins.attrNames --json | jq -r '.[0]')
          echo "Building configuration: $CONFIG"
          nix build .#nixosConfigurations.$CONFIG.config.system.build.toplevel --dry-run

  test-validation:
    name: Test configuration validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Test basic configuration builds
        run: |
          echo "ðŸ§ª Testing basic configuration..."

          AXIOS_PATH="${GITHUB_WORKSPACE}"

          # Create test config with minimal valid setup
          mkdir -p /tmp/test-config
          cat > /tmp/test-config/user.nix << 'EOF'
          { ... }: { 
            users.users.test = {
              isNormalUser = true;
              description = "Test User";
            };
          }
          EOF

          cat > /tmp/test-config/flake.nix << EOF
          {
            inputs.axios.url = "path:${AXIOS_PATH}";
            inputs.nixpkgs.follows = "axios/nixpkgs";
            outputs = { axios, ... }: {
              nixosConfigurations.test = axios.lib.mkSystem {
                hostname = "test";
                system = "x86_64-linux";
                formFactor = "desktop";
                hardware = {
                  cpu = "amd";
                  gpu = "amd";
                  hasSSD = true;
                  isLaptop = false;
                };
                modules = {
                  system = true;
                  desktop = true;
                  networking = true;
                  users = true;
                };
                homeProfile = "workstation";
                userModulePath = ./user.nix;
                extraConfig = {
                  # Required: Set timezone
                  axios.system.timeZone = "America/New_York";
                };
              };
            };
          }
          EOF

          echo "Testing that basic configuration validates..."
          if nix flake check --no-build /tmp/test-config 2>&1; then
            echo "âœ… Basic configuration validates successfully"
          else
            echo "âŒ Basic configuration failed to validate"
            nix flake check --no-build /tmp/test-config 2>&1 || true
            exit 1
          fi
