# Networking & Self-Hosted Services

> **Delta**: Additions to the Tailscale section for loopback secure context proxy.

## ADDED Requirements

### Requirement: Loopback Secure Context Proxy

Tailscale services SHALL support an optional local HTTPS reverse proxy for secure context on the serving node.

#### Scenario: Service with loopbackProxy enabled

- **Given**: A Tailscale service is configured with `loopbackProxy.enable = true`
- **And**: `networking.tailscale.domain` is set (e.g., `example-tailnet.ts.net`)
- **When**: NixOS configuration is evaluated
- **Then**: A systemd cert sync service provisions a Let's Encrypt certificate via `tailscale cert` for `<service>.<tailnetDomain>`
- **And**: A daily systemd timer renews the certificate
- **And**: An nginx virtualHost is generated listening on `127.0.0.1:443` with SSL using the provisioned certificate
- **And**: The virtualHost proxies requests to the service's `backend` URL with WebSocket support
- **And**: An `/etc/hosts` entry maps `<service>.<tailnetDomain>` to `127.0.0.1`
- **And**: `services.nginx.enable` is set to `true`

#### Scenario: Service without loopbackProxy (default)

- **Given**: A Tailscale service is configured without `loopbackProxy.enable`
- **When**: NixOS configuration is evaluated
- **Then**: No nginx virtualHost is generated for this service
- **And**: No certificate sync service is created for this service
- **And**: No `/etc/hosts` entry is generated by the Tailscale module for this service
- **And**: The service operates as before (plain HTTP on localhost, `tailscale serve` for remote access)

#### Scenario: No services use loopbackProxy

- **Given**: No Tailscale services have `loopbackProxy.enable = true`
- **When**: NixOS configuration is evaluated
- **Then**: nginx is NOT enabled by the Tailscale module
- **And**: No certificate directory is created
- **And**: No cert sync timers are created

#### Scenario: loopbackProxy requires tailscale domain

- **Given**: A Tailscale service has `loopbackProxy.enable = true`
- **And**: `networking.tailscale.domain` is not set
- **When**: NixOS configuration is evaluated
- **Then**: An assertion error is raised
- **And**: The error message explains that `networking.tailscale.domain` is required for loopback proxy

#### Scenario: Certificate sync waits for Tailscale

- **Given**: A service has `loopbackProxy.enable = true`
- **When**: The system boots
- **Then**: The cert sync service waits for `tailscaled.service` to reach Running state
- **And**: The cert sync service runs `tailscale cert` with the correct FQDN
- **And**: Certificate and key files are written to `/var/lib/tailscale/certs/`
- **And**: Key file permissions are set so nginx can read them (0640, group nginx)
- **And**: nginx is reloaded after cert renewal

#### Scenario: Remote clients unaffected

- **Given**: A service has `loopbackProxy.enable = true` on the server
- **When**: A remote client resolves `<service>.<tailnetDomain>` via Tailscale DNS
- **Then**: The client reaches the Tailscale Services VIP (not `127.0.0.1`)
- **And**: Traffic flows through Tailscale as before
- **And**: The loopback proxy has no effect on remote access

## MODIFIED Requirements

### Requirement: Tailscale Service Submodule Options

The Tailscale service submodule SHALL include a `loopbackProxy` option group.

#### Scenario: Service submodule with loopbackProxy option

- **Given**: A user defines a Tailscale service
- **When**: The service submodule is evaluated
- **Then**: The following options are available:
  - `enable` (bool) -- enable/disable the service (existing)
  - `backend` (str) -- backend URL (existing)
  - `port` (port, default 443) -- HTTPS port for `tailscale serve` (existing)
  - `loopbackProxy.enable` (bool, default false) -- enable local nginx HTTPS proxy for secure context (NEW)
