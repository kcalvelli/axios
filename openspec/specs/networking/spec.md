# Networking: Tailscale Services

## Purpose

Manages Tailscale service registration and optional loopback HTTPS proxy for server-local secure context.

## Components

### Tailscale Services

- **Protocol**: Mesh VPN with automatic HTTPS via `tailscale serve`
- **Requirement**: `networking.tailscale.domain` must be set for service routing
- **Implementation**: `modules/networking/tailscale.nix`

### Loopback Secure Context Proxy

- **Purpose**: Provides a valid W3C Secure Context for server-local PWAs by running nginx on `127.0.0.1:443` with real Let's Encrypt certificates from `tailscale cert`
- **Motivation**: Tailscale Services VIPs cannot be reached from the serving node (kernel-level hairpinning restriction). Plain HTTP `.local` URLs are not secure contexts, breaking Web Push (`PushManager.subscribe()`) and other security-gated browser APIs.
- **Architecture**:
  ```
  Browser -> https://<service>.<tailnet>.ts.net
          -> /etc/hosts resolves to 127.0.0.1 (server only)
          -> nginx (127.0.0.1:443) with real LE cert
          -> proxy_pass to 127.0.0.1:<port> (app backend)
          -> valid secure context
  ```
- **Remote clients**: Completely unaffected. They resolve via Tailscale DNS to the VIP as before.
- **Implementation**: `modules/networking/tailscale.nix` (cert sync services, nginx virtualHosts, /etc/hosts entries)

## Configuration

### Tailscale Service Submodule Options

```nix
networking.tailscale.services."<name>" = {
  enable = lib.mkEnableOption "this Tailscale service";
  backend = lib.mkOption {
    type = lib.types.str;
    description = "Backend URL (e.g., http://127.0.0.1:8080)";
  };
  port = lib.mkOption {
    type = lib.types.port;
    default = 443;
    description = "HTTPS port for tailscale serve";
  };
  loopbackProxy = {
    enable = lib.mkEnableOption "local nginx HTTPS proxy for secure context";
  };
};
```

## Requirements

### Requirement: Loopback Secure Context Proxy

Tailscale services SHALL support an optional local HTTPS reverse proxy for secure context on the serving node.

#### Scenario: Service with loopbackProxy enabled

- **Given**: A Tailscale service is configured with `loopbackProxy.enable = true`
- **And**: `networking.tailscale.domain` is set (e.g., `example-tailnet.ts.net`)
- **When**: NixOS configuration is evaluated
- **Then**: A systemd cert sync service provisions a Let's Encrypt certificate via `tailscale cert` for `<service>.<tailnetDomain>`
- **And**: A daily systemd timer renews the certificate
- **And**: An nginx virtualHost is generated listening on `127.0.0.1:443` with SSL using the provisioned certificate
- **And**: The virtualHost proxies requests to the service's `backend` URL with WebSocket support
- **And**: An `/etc/hosts` entry maps `<service>.<tailnetDomain>` to `127.0.0.1`
- **And**: `services.nginx.enable` is set to `true`

#### Scenario: Service without loopbackProxy (default)

- **Given**: A Tailscale service is configured without `loopbackProxy.enable`
- **When**: NixOS configuration is evaluated
- **Then**: No nginx virtualHost is generated for this service
- **And**: No certificate sync service is created for this service
- **And**: No `/etc/hosts` entry is generated by the Tailscale module for this service
- **And**: The service operates as before (plain HTTP on localhost, `tailscale serve` for remote access)

#### Scenario: No services use loopbackProxy

- **Given**: No Tailscale services have `loopbackProxy.enable = true`
- **When**: NixOS configuration is evaluated
- **Then**: nginx is NOT enabled by the Tailscale module
- **And**: No certificate directory is created
- **And**: No cert sync timers are created

#### Scenario: loopbackProxy requires tailscale domain

- **Given**: A Tailscale service has `loopbackProxy.enable = true`
- **And**: `networking.tailscale.domain` is not set
- **When**: NixOS configuration is evaluated
- **Then**: An assertion error is raised
- **And**: The error message explains that `networking.tailscale.domain` is required for loopback proxy

#### Scenario: Certificate sync waits for Tailscale

- **Given**: A service has `loopbackProxy.enable = true`
- **When**: The system boots
- **Then**: The cert sync service waits for `tailscaled.service` to reach Running state
- **And**: The cert sync service runs `tailscale cert` with the correct FQDN
- **And**: Certificate and key files are written to `/var/lib/tailscale-certs/`
- **And**: File ownership is set to `root:nginx` on both cert and key
- **And**: Cert file permissions are `0644`, key file permissions are `0640`
- **And**: nginx is reloaded if running, restarted if in failed state, skipped if not yet started

#### Scenario: Remote clients unaffected

- **Given**: A service has `loopbackProxy.enable = true` on the server
- **When**: A remote client resolves `<service>.<tailnetDomain>` via Tailscale DNS
- **Then**: The client reaches the Tailscale Services VIP (not `127.0.0.1`)
- **And**: Traffic flows through Tailscale as before
- **And**: The loopback proxy has no effect on remote access

### Requirement: Tailscale Service Submodule Options

The Tailscale service submodule SHALL include a `loopbackProxy` option group.

#### Scenario: Service submodule with loopbackProxy option

- **Given**: A user defines a Tailscale service
- **When**: The service submodule is evaluated
- **Then**: The following options are available:
  - `enable` (bool) -- enable/disable the service (existing)
  - `backend` (str) -- backend URL (existing)
  - `port` (port, default 443) -- HTTPS port for `tailscale serve` (existing)
  - `loopbackProxy.enable` (bool, default false) -- enable local nginx HTTPS proxy for secure context

## Constraints

- **Loopback Only**: nginx listens exclusively on `127.0.0.1:443` to avoid conflicting with `tailscale serve` on the Tailscale interface
- **onlySSL Required**: nginx virtualHosts must set `onlySSL = true` to trigger SSL certificate rendering; the explicit `listen` directive overrides onlySSL's default listeners
- **Cert Directory**: Certificates are stored in `/var/lib/tailscale-certs/` (NOT under `/var/lib/tailscale/` which is `0700 root:root` and inaccessible to nginx)
- **Real Certificates**: Uses Let's Encrypt certificates via `tailscale cert` â€” no self-signed certificates
- **Generic Pattern**: The loopback proxy logic iterates over `cfg.services`; no service names are hardcoded
- **Opt-In**: `loopbackProxy.enable` defaults to `false`; services must explicitly opt in

## References

- **Port Allocations**: See `openspec/specs/networking/ports.md`
- **Services Spec**: See `openspec/specs/services/spec.md` for Caddy route registry and self-hosted services
- **PIM Integration**: See `openspec/specs/pim/spec.md` for axios-mail loopback proxy usage

---

*Last updated: January 2026*
